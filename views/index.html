<html>

    <head>

        <script type="text/javascript" src="/static/jquery/jquery.js"></script>

        <script type="text/javascript" src="/socket.io/socket.io.js"></script>

        <script type="text/javascript" src="/static/webrtc/shim/adapter.js"></script>

        <script type="text/javascript" src="/static/webrtc/client.js"></script>

        <script type="text/javascript" src="/static/threejs/three.min.js"></script>

        <script type="text/javascript" src="/static/demo/demo.js"></script>

        <script type="text/javascript">

            var app        = null;

            var player     = null;

            var socket     = null;

            var logger     = null;

            var signaller  = null;

            var client     = null;

            function connect(userid) {

                client.connect(userid);
            }
            
            function login() {

                setup_graphics();

                setup_network();

                setup_player();
            }

            function setup_network() {

                socket    = io.connect();

                signaller = new webrtc.SocketIOSignaller(socket);

                logger    = new webrtc.NullLogger();

                client    = new webrtc.Client($('#userid').val(), signaller, logger);

                client.onServerSync = function(userids) {

                    for(var i = 0; i < userids.length; i++) {

                        if(userids[i] != client.userid) {

                            var peer = client.getPeer(userids[i])

                            if(!peer) {

                                client.connect(userids[i]);
                            }
                        }
                    }
                }

                client.onConnect = function(peer) {
                    
                    var player = app.getPlayer(peer.userid);

                    if(!player) {

                        app.createPlayer(peer.userid);
                    }
                }

                client.onMessage = function(peer, message) {

                    var update = JSON.parse(message.data);

                    if(update.type == 'updatePlayer') {

                        app.updatePlayer(peer.userid, update.x, update.y, update.z, update.angle);
                    }
                }
            }

            function setup_player() {

                player = app.createPlayer(client.userid);

                update_player_data();

                setInterval(function() {

                    update_player_data();

                }, 2000);
            }

            function setup_graphics() {

                app = new demo.App( document.getElementById('app'), 800, 800 );
                
                var render = function() {

                    requestAnimationFrame( render );

                    app.render();
                }

                render();
            }

            function update_player_data() {

                app.updatePlayer(player.userid, player.x, player.y, player.z, player.angle);
                    
                app.lookAtPlayer(player.userid);
                    
                client.broadcast(JSON.stringify({
                    type     : 'updatePlayer',

                    x        : player.x,

                    y        : player.y,

                    z        : player.z,

                    angle    : player.angle
                }));

                

            }

            document.onkeydown = checkKey;

            function checkKey(e) {

                if(player) {

                    e = e || window.event;

                    switch(e.keyCode) {

                        case 37: 
                            
                            player.angle += 5;
                            
                            break; // left

                        case 39: 
                            
                            player.angle -= 5;
                            
                            break; // right

                        case 38: 

                            var x = Math.sin(player.angle * 3.14 / 180);

                            var y = Math.cos(player.angle * 3.14 / 180);
                            
                            player.x += x; 

                            player.z += y;                             
                            
                            break; // up

                        case 40: 

                            var x = Math.sin(player.angle * 3.14 / 180);

                            var y = Math.cos(player.angle * 3.14 / 180);
                            
                            player.x -= x; 

                            player.z -= y;                             
                            
                            break; // up
                    }

                    update_player_data();
                     
                }
            }
        </script>

    </head>

    <body>

        <div id="container-login">

            <input type="text" id="userid" />

            <input type="button" id="login" value="login" onclick="login()" />

        </div>

        <div id="app"></div>

    </body>

</html>
